---
title: mit6.s081 lab4
date: 2025-02-02 00:53:20
tags: mit6.s081
---

## RISC-V assembly

è¿™ä¸ªlabæ˜¯å›ç­”ä¸€ä¸‹é—®é¢˜å¹¶è®°å½• æ­¤å¤„å°±ç›´æ¥æŠŠé—®é¢˜åˆ†æå’Œç­”æ¡ˆæ‰“ä¸Šæ¥äº† ç­”æ¡ˆé€šè¿‡chatGPTæŸ¥éªŒ

`call.asm`ä¸­çš„`g`ã€`f`ã€`main`å…·ä½“çš„ä»£ç 

```asm
int g(int x) {
   0:	1141                	addi	sp,sp,-16
   2:	e422                	sd	s0,8(sp)
   4:	0800                	addi	s0,sp,16
  return x+3;
}
   6:	250d                	addiw	a0,a0,3
   8:	6422                	ld	s0,8(sp)
   a:	0141                	addi	sp,sp,16
   c:	8082                	ret

000000000000000e <f>:

int f(int x) {
   e:	1141                	addi	sp,sp,-16
  10:	e422                	sd	s0,8(sp)
  12:	0800                	addi	s0,sp,16
  return g(x);
}
  14:	250d                	addiw	a0,a0,3
  16:	6422                	ld	s0,8(sp)
  18:	0141                	addi	sp,sp,16
  1a:	8082                	ret

000000000000001c <main>:

void main(void) {
  1c:	1141                	addi	sp,sp,-16
  1e:	e406                	sd	ra,8(sp)
  20:	e022                	sd	s0,0(sp)
  22:	0800                	addi	s0,sp,16
  printf("%d %d\n", f(8)+1, 13);
  24:	4635                	li	a2,13
  26:	45b1                	li	a1,12
  28:	00001517          	auipc	a0,0x1
  2c:	80850513          	addi	a0,a0,-2040 # 830 <malloc+0xec>
  30:	00000097          	auipc	ra,0x0
  34:	65c080e7          	jalr	1628(ra) # 68c <printf>
  exit(0);
  38:	4501                	li	a0,0
  3a:	00000097          	auipc	ra,0x0
  3e:	2b8080e7          	jalr	696(ra) # 2f2 <exit>
```

è¿™é‡Œæ¶‰åŠåˆ°çš„å¾ˆå¤šä»£ç å¯ä»¥ç²—ç•¥ç†è§£ä¸ºä¸‰ä¸ªå±‚æ¬¡

**å‡†å¤‡ç°åœº -> å‡½æ•°è°ƒç”¨ã€æ‰§è¡Œé€»è¾‘ -> æ¢å¤ç°åœº**



**å‡†å¤‡ç°åœºå¦‚ä½•åšï¼Ÿ** æ­¤å¤„ä»¥`g`å‡½æ•°ä¸ºä¾‹å­

```asm
addi	sp,sp,-16
sd	s0,8(sp)
addi	s0,sp,16
```

è¿™é‡Œé¦–å…ˆæ˜¯é€šè¿‡ç§»åŠ¨SPæ ˆæŒ‡é’ˆ åˆ†é…äº†16å­—èŠ‚çš„ç©ºé—´

ç„¶åå°†s0å¯„å­˜å™¨ä¸­å€¼ä¿å­˜åˆ°åˆšåˆšåˆ†é…åˆ°çš„ç©ºé—´çš„åŸºç¡€ä¸Š åç§»é‡ä¸º8çš„ä½ç½®

ç„¶åä¿®æ”¹s0å¯„å­˜å™¨ä¸­çš„å€¼ è®©å®ƒä¹‹ä¸Šå½“å‰åˆ†é…çš„æ ˆçš„æ ˆé¡¶

```asm
   6:	250d                	addiw	a0,a0,3
```

çœŸæ­£æ‰§è¡Œè®¡ç®— RISC-Vä¸­ å‡½æ•°ä¼ å…¥çš„å€¼ä¸€èˆ¬éƒ½æ˜¯æ”¾åœ¨`a0`å¯„å­˜å™¨å½“ä¸­çš„ å¦‚æœä¸å¤Ÿæ”¾çš„è¯ ä¾æ¬¡ä¼šæ”¾åˆ°`a1`ã€`a2`ç­‰å¯„å­˜å™¨å½“ä¸­

è¿”å›å€¼åˆ™ä¼šæ”¾åˆ°`a0`å¯„å­˜å™¨å½“ä¸­

è¿™åº”è¯¥ç®—æ˜¯RISC-Vä¸­çº¦å®šä¿—æˆçš„ä¸€ç§è§„èŒƒå§

```asm
   8:	6422                	ld	s0,8(sp)
   a:	0141                	addi	sp,sp,16
   c:	8082                	ret
```

è¿™é‡Œå°±æ˜¯æ¢å¤ç°åœºå¹¶ä¸”`ret`è·³è½¬çš„ä»£ç äº†

å°†ä»spä¸­åç§»é‡ä¸º8 ä¹‹å‰å‡†å¤‡ç°åœºæ—¶ä¿æŠ¤çš„å€¼æ‹¿å‡ºæ¥ é‡æ–°æ”¾å›åˆ°s0å½“ä¸­

ç„¶åé‡æ–°ä¿®æ”¹æ ˆæŒ‡é’ˆ å›æ”¶è¯¥å‡½æ•°æ‰€ä½¿ç”¨çš„ç©ºé—´

æœ€åretè·³è½¬ ï¼ˆå…·ä½“åœ°å€ä¸€èˆ¬åœ¨å¤–éƒ¨è·³è½¬è¿™ä¸ªå‡½æ•°çš„æ—¶å€™ å¤–éƒ¨è¿›è¡Œè®¾ç½®å¥½ æ‰€ä»¥è¿™é‡Œä¸ç”¨è®¾ç½®ï¼‰



å¯ä»¥çœ‹åˆ°`f`å‡½æ•°æ˜¯ç›´æ¥`return g(x)` ä½†æ˜¯æ±‡ç¼–ä¸­æ˜¯å› ä¸ºç¼–è¯‘å™¨ç»è¿‡äº†å†…è”ä¼˜åŒ–

æ²¡æœ‰è¿›è¡Œè·³è½¬ è€Œæ˜¯ç›´æ¥å°†`g`å‡½æ•°ä¸­çš„ä»£ç å¤åˆ¶äº†è¿‡æ¥

æ‰€ä»¥è¿™é‡Œä¸å†ä½œè§£é‡Š



å¯¹äº`main`å‡½æ•° ä¹Ÿå¯ä»¥ç”¨è¿™ç§æ€è·¯è¿›è¡Œæ€è€ƒ

```asm
  1c:	1141                	addi	sp,sp,-16
  1e:	e406                	sd	ra,8(sp)
  20:	e022                	sd	s0,0(sp)
  22:	0800                	addi	s0,sp,16
```

ç”±äº`main`å‡½æ•°æ˜¯ä¸»å‡½æ•° æ‰€ä»¥éœ€è¦åŒæ—¶è®¾ç½®è¿”å›æ—¶è·³è½¬çš„åœ°å€ å³ä¿å­˜åœ¨`ra`å¯„å­˜å™¨å½“ä¸­

â€‹	

```asm
  24:	4635                	li	a2,13
  26:	45b1                	li	a1,12
  28:	00001517          	auipc	a0,0x1
  2c:	80850513          	addi	a0,a0,-2040 # 830 <malloc+0xec>
  30:	00000097          	auipc	ra,0x0
  34:	65c080e7          	jalr	1628(ra) # 68c <printf>
```

è¿™é‡Œå°±æ˜¯å°†æ•°æ®è¿›è¡Œå¤„ç†äº†

å¯¹ç…§ä¸€ä¸‹åŸæ¥çš„cä»£ç å¯ä»¥å‘ç°è¿™é‡Œæ˜¯ç›´æ¥å°†`f(8)`çš„å€¼è®¡ç®—äº†å‡ºæ¥ å’Œ`13`ä¸€èµ·æ”¾è¿›äº†å¯„å­˜å™¨ä¸­ ç­‰å¾…è°ƒç”¨

è¿™ä¸ªä¹Ÿæ˜¯ç¼–è¯‘å™¨ä¼˜åŒ–çš„é”… ä»–å°†`f(8)`è¿™ä¸€å‡½æ•°è°ƒç”¨çš„è¿‡ç¨‹çœç•¥äº† æ˜¯ **å¸¸é‡æŠ˜å **çš„ä½“ç° ç›´æ¥å°†å…¶ä¸­çš„å€¼ç”±ç¼–è¯‘å™¨è®¡ç®—å‡ºå¹¶ä¸”ä»£å…¥



è¦æ³¨æ„è°ƒç”¨printfçš„è¿‡ç¨‹æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€æ¬¡å‡½æ•°è°ƒç”¨ 

æ‰€ä»¥ä¹Ÿæ˜¯éœ€è¦å‡†å¤‡ç°åœºçš„ è¿™é‡Œä½“ç°åœ¨å°†è®¡ç®—å‚æ•°æ”¾å…¥å¯„å­˜å™¨å½“ä¸­

é€šè¿‡æŒ‡é’ˆè¿ç®— è®¡ç®—å‡º`printf()`å‡½æ•°çš„å®é™…ä½ç½®

æœ€åè¿›è¡Œè·³è½¬



```asm
  38:	4501                	li	a0,0
  3a:	00000097          	auipc	ra,0x0
  3e:	2b8080e7          	jalr	696(ra) # 2f2 <exit>
```

è¿™ä¸€ä¸ªé˜¶æ®µä¸‹ æ˜¯è®¡ç®—å·²ç»å®Œæˆäº†

ç”±äº`printf`æˆ–è€…å…¶ä»–å‡½æ•°è°ƒç”¨çš„è¿”å›å€¼éƒ½æ˜¯ä¼šå­˜åœ¨å¯„å­˜å™¨`a0`å½“ä¸­çš„

æ‰€ä»¥æ­¤å¤„éœ€è¦å°†ä»–ç½®0 æ¢å¤ä¸€å¼€å§‹çš„ç°åœº

ç„¶åå†å¯¹æŒ‡é’ˆè¿›è¡Œè®¡ç®— è®¡ç®—å‡º`ret`æ‰€è·³è½¬çš„åœ°å€

 ï¼ˆæ­¤æƒ…å¢ƒä¸‹ æ˜¯ä»`printf()`å‡½æ•°å†…éƒ¨è·³è½¬å›`main()`å‡½æ•°å½“ä¸­ï¼‰

è·³è½¬å›æ¥äº† ç›´æ¥æ‰§è¡Œæœ€åçš„`exit(0)`æŒ‡ä»¤ è·³è½¬åˆ°`exit`å¯¹åº”çš„ä½ç½®



è‡³æ­¤ è°ƒç”¨ç»“æŸ



ç†è§£äº†æ•´ä¸ªæµç¨‹ä¹‹å å°±å¾ˆå¥½å›ç­”labä¸Šçš„é—®é¢˜äº†

1. 

Q: **Which registers contain arguments to functions? For example, which register holds 13 in main's call to `printf`?**
å“ªäº›å¯„å­˜å™¨åŒ…å«å‡½æ•°çš„å‚æ•°ï¼Ÿä¾‹å¦‚ï¼Œä¸»å‡½æ•°è°ƒç”¨ `printf` æ—¶ï¼Œå“ªä¸ªå¯„å­˜å™¨ä¿å­˜äº† 13ï¼Ÿ

A: åŒ…å«å‚æ•°çš„å¯„å­˜å™¨æœ‰`a0`ã€`a1`ã€`a2`ç­‰ç­‰... è¿™é‡Œè°ƒç”¨`printf`çš„æ—¶å€™ æ˜¯`a2`ä¿å­˜äº†13

```asm
  24:	4635                	li	a2,13
```

2. 

Q: **Where is the call to function `f` in the assembly code for main? Where is the call to `g`? (Hint: the compiler may inline functions.)**
åœ¨ä¸»ç¨‹åºçš„æ±‡ç¼–ä»£ç ä¸­ï¼Œè°ƒç”¨å‡½æ•° `f` åœ¨å“ªé‡Œï¼Ÿè°ƒç”¨ `g` åœ¨å“ªé‡Œï¼Ÿï¼ˆæç¤ºï¼šç¼–è¯‘å™¨å¯èƒ½ä¼šå†…è”å‡½æ•°ã€‚ï¼‰

A: è°ƒç”¨å‡½æ•°æŒ‰ç†æ¥è¯´æ˜¯ä¼šåœ¨45 47è¡Œä¸­é—´ ä½†æ˜¯æ­¤å¤„ç¼–è¯‘å™¨ä¼˜åŒ–è¿›è¡Œäº†å¸¸é‡æŠ˜å ã€‚ç†è®ºä¸Šæ˜¯åœ¨è¿™ä¸€å—ä¼šè¿›è¡Œä¸¤æ¬¡åµŒå¥—çš„åˆ†é…æ ˆç©ºé—´ ä¾æ¬¡åˆ°`f`ã€`g`å‡½æ•°ä¸­å¯¹å€¼è¿›è¡Œè®¡ç®—ï¼Œå†ä¾æ¬¡æ¢å¤



3. 

Q: **At what address is the function `printf` located?**
å‡½æ•° `printf` ä½äºå“ªä¸ªåœ°å€ï¼Ÿ

A: åœ¨è¿™é‡Œ `printf()`å…·ä½“çš„åœ°å€è®¡ç®—è¿‡ç¨‹æ˜¯ï¼šå…ˆå°†`PC`å¯„å­˜å™¨å’Œ`0x1`è¿›è¡Œè®¡ç®— å¾—å‡ºçš„å€¼å­˜åˆ°`a0`å½“ä¸­ ç„¶åå°†`a0`çš„å€¼å‡å»2040æ‰€å¾—åˆ°çš„

**ä¹Ÿå°±æ˜¯è¯´  å®ƒçš„ä½ç½®å¹¶ä¸æ˜¯å›ºå®šçš„ æ˜¯é€šè¿‡è®¡ç®—ä»è€ŒåŠ¨æ€ç¡®å®šçš„**



4. 

Q: **What value is in the register `ra` just after the `jalr` to `printf` in `main`?**
åœ¨ `main` ä¸­ï¼Œ `jalr` åˆ° `printf` ä¹‹åï¼Œå¯„å­˜å™¨ `ra` ä¸­çš„å€¼æ˜¯ä»€ä¹ˆï¼Ÿ

A: ä¸Šæ–¹ä¹Ÿå·²ç»è§£é‡Šè¿‡ è·³è½¬åˆ°`printf`çš„è¿‡ç¨‹æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€æ¬¡è°ƒç”¨ åŒæ ·éœ€è¦å‡†å¤‡ç°åœºç­‰æ­¥éª¤ è€Œåœ¨æ‰§è¡Œå®Œæ¯•ä¹‹å æ˜¯ä¼šè·³è½¬åˆ°å½“å‰`main`å‡½æ•°ä¸‹ `jalr`çš„ä¸‹ä¸€æ¡æŒ‡ä»¤



5. 

*TODO è¿™ç©æ„åŠå¤œæœ‰ç‚¹çœ‹ä¸æ‡‚*

**Run the following code.**
è¿è¡Œä»¥ä¸‹ä»£ç ã€‚

```
	unsigned int i = 0x00646c72;
	printf("H%x Wo%s", 57616, &i);
```

**What is the output? [Here's an ASCII table](http://web.cs.mun.ca/~michael/c/ascii-table.html) that maps bytes to characters.**
è¿™æ˜¯ä»€ä¹ˆè¾“å‡ºï¼Ÿè¿™æ˜¯ä¸€ä¸ª ASCII è¡¨ï¼Œå®ƒå°†å­—èŠ‚æ˜ å°„åˆ°å­—ç¬¦ã€‚

**The output depends on that fact that the RISC-V is little-endian. If the RISC-V were instead big-endian what would you set `i` to in order to yield the same output? Would you need to change `57616` to a different value?**
è¾“å‡ºå–å†³äº RISC-V æ˜¯å°ç«¯çš„è¿™ä¸ªäº‹å®ã€‚å¦‚æœ RISC-V æ˜¯å¤§ç«¯çš„ï¼Œä½ ä¼šå°† `i` è®¾ç½®ä¸ºä»€ä¹ˆå€¼ä»¥äº§ç”Ÿç›¸åŒçš„è¾“å‡ºï¼Ÿä½ éœ€è¦å°† `57616` æ”¹ä¸ºä¸åŒçš„å€¼å—ï¼Ÿ

**[Here's a description of little- and big-endian](http://www.webopedia.com/TERM/b/big_endian.html) and [a more whimsical description](http://www.networksorcery.com/enp/ien/ien137.txt).**
è¿™æ˜¯å¯¹å°ç«¯å’Œå¤§ç«¯çš„æè¿°ï¼Œä»¥åŠä¸€ä¸ªæ›´å¯Œæœ‰æƒ³è±¡åŠ›çš„æè¿°ã€‚





---



## Backtrace

è¯¥labä¸ºæ‰“å°ç¨‹åºè°ƒç”¨æ—¶çš„å †æ ˆä¿¡æ¯ é‡ç‚¹åœ¨ç†è§£`fp`,`sp`,`ra`ç­‰æ¦‚å¿µä»¥åŠä½œç”¨

å…¶ä»–éƒ¨åˆ†æš‚ä¸è¯´æ˜ è¿™é‡Œä»…è§£é‡Šlabä¸­æ‰€éœ€ç”¨åˆ°çš„éƒ¨åˆ†

 ![stack-architect](/images/stack_architect.png)

è¿™ä¸ªæ˜¯lectureä¸­ä»‹ç»çš„æ ˆç»“æ„ ç”±äºåœ¨xv6ä¸­ åœ°å€æ˜¯ç”±é«˜åˆ°ä½è¿›è¡Œåˆ†é…çš„ æ‰€ä»¥åœ¨è¿™é‡Œå¯ä»¥å’Œhintsä¸­å¯ä»¥è§‚å¯Ÿåˆ°

`fp`å’Œ`ra`çš„åœ°å€éƒ½æ˜¯éœ€è¦`fp - offset`è¿™ç§æ–¹å¼è®¡ç®—å‡ºæ¥çš„

`ra`ä¸­å­˜å‚¨çš„å³ä¸ºè¿”å›åœ°å€ å¯ä»¥é€šè¿‡`*(void *)(sp - 8)`è®¡ç®—å¾—å‡º

`fp`ä¸­å­˜å‚¨çš„æ˜¯**ä¸Šä¸€ä¸ªè°ƒç”¨è€…çš„`sp`åœ°å€** ä¹Ÿæ˜¯æˆ‘ä»¬éå†å †æ ˆæ‰€éœ€ç”¨åˆ°çš„æ ¸å¿ƒå€¼ ï¼ˆå¯ä»¥ç±»æ¯”é“¾è¡¨æ ‘ç­‰çš„éå†æ–¹æ³•æ€è€ƒï¼‰

å®ƒçš„å€¼å¯ä»¥é€šè¿‡`*(void *)(sp - 16)`å¾—å‡º



æ€»ç»“ä¸€ä¸‹ä¸Šé¢çš„ä¿¡æ¯ æ•´ä¸ªä»£ç çš„æ€è·¯å°±æ¯”è¾ƒæ¸…æ¥šäº†

ä¸»è¦å°±æ˜¯æ„å»ºä¸€ä¸ªå¾ªç¯ï¼ˆæˆ–è€…é€’å½’ï¼‰ ä»ç°æœ‰çš„`sp`è®¡ç®—å‡º`fp`ï¼Œ`ra` ç„¶ååŸºäº`fp`è¿›è¡Œä¸‹ä¸€æ¬¡çš„éå†

ç»“åˆhints ä»¥é¡µé¡¶éƒ¨ä¸åº•éƒ¨ä½œä¸ºéå†è¾¹ç•Œå€¼ è¶…è¿‡å€¼é»˜è®¤ç»ˆæ­¢å¾ªç¯



ä»`kernel/printf.c`ä¸­æ”¹èµ·

```c
void backtrace(void) {
    printf("backtrace:\n");
    
    // è·å–å½“å‰æ ˆå†…çš„fp ï¼ˆä¸Šä¸€ä¸ªè°ƒç”¨è€…æ ˆå†…çš„æ ˆæŒ‡é’ˆï¼‰
    uint64 fp = r_fp();
    uint64 bottom = PGROUNDDOWN(fp);
    uint64 top = PGROUNDUP(fp);

    //è¶…å‡ºå½“å‰æ ˆé»˜è®¤éå†å®Œæ¯•
    // å…·ä½“å¯å‚è§xv6ä¸­çš„æ ˆç»“æ„ fpä¸­å­˜å‚¨çš„æ˜¯ä¸Šä¸€ä¸ªè°ƒç”¨è€…çš„æŒ‡é’ˆä½ç½® ç±»æ¯”é“¾è¡¨æ ‘
    // æ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡è¿™ä¸ªfpç´¢å¼•å¹¶ä¸”æ‰“å°è°ƒç”¨é“¾
    while (fp >= bottom && fp < top) {
        printf("%p\n",  *(uint64*)(fp - 8));
        fp = *(uint64*)(fp - 16);
    }
    return;
}
```

å…¶ä»–å°±ä¸éœ€è¦æ”¹ä»€ä¹ˆäº†

`sysproc.c`

```c
uint64 sys_sleep(void) {
	...
    backtrace();
    return 0;
}
```

`riscv.h`

```c
// read value in s0 (which storage the stack frame pointer)
// è¯»å–å½“å‰çš„å¸§æŒ‡é’ˆå¹¶ä¸”è¿”å›
static inline uint64 r_fp() {
    uint64 x;
    asm volatile("mv %0, s0" : "=r"(x));
    return x;
}
```

`defs.h`

```c
// printf.c
void backtrace(void);
...
```

æµ‹è¯•å’Œè„šæœ¬è¿è¡Œæ•ˆæœğŸ‘‰ï¼š

```sh
$ bttest
backtrace:
0x0000000080002524
0x0000000080002356
0x0000000080002044
$ QEMU: Terminated
chenz@Chenzc:~/lab$ addr2line -e kernel/kernel
0x0000000080002524
/home/chenz/lab/kernel/sysproc.c:64
0x0000000080002356
/home/chenz/lab/kernel/syscall.c:143
0x0000000080002044
/home/chenz/lab/kernel/trap.c:80
```

æ³¨æ„ éªŒè¯æ–¹å¼æ˜¯å°†è‡ªå·±é€šè¿‡è¿è¡Œ`bttest`å¾—åˆ°çš„`va`é€šè¿‡`add2line`è¿›è¡ŒéªŒè¯... å¯èƒ½ä¼šä¸å®˜æ–¹å­˜åœ¨äº›è®¸ä¸åŒ

```sh
chenz@Chenzc:~/lab$ sudo python3 grade-lab-traps backtrace
make: 'kernel/kernel' is up to date.
== Test backtrace test == backtrace test: OK (3.0s)
```

